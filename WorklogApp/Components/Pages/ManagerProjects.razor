@page "/manager/projects"
@using WorklogApp.Models
@using WorklogApp.Services
@inject ProjectService ProjectService
@inject NavigationManager Navigation

<ProtectedPage TPage="object" AllowedRoles="@managerRoles">

    <h3 style="color:#6247aa; padding:0.75rem 1rem; text-align:center">
        Project Management
    </h3>

    <button type="button" @onclick="ShowAddProject"
            style="background:linear-gradient(90deg,#a06cd5,#6247aa);
                   border:none; padding:0.6rem 1.25rem;
                   border-radius:0.5rem; color:white; font-weight:600;
                   box-shadow:0 3px 8px rgba(0,0,0,0.25);
                   transition:all 0.3s ease; margin-bottom:1rem; cursor:pointer;"
            onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 18px rgba(98,71,170,0.5)'"
            onmouseout="this.style.transform='none';this.style.boxShadow='0 3px 8px rgba(0,0,0,0.25)'">
        ➕ Add Project
    </button>

    @if (projects == null)
    {
        <p><em>Loading...</em></p>
    }
    else
    {
        <table style="width:100%; border-collapse:collapse; background:#f7f0fc;
                          border-radius:0.75rem; overflow:hidden;
                          box-shadow:0 4px 12px rgba(0,0,0,0.15);">
            <thead style="background:linear-gradient(90deg,#a06cd5,#6247aa); color:white;">
                <tr>
                    <th style="padding:0.75rem; text-align:left;">Project Id</th>
                    <th style="padding:0.75rem; text-align:left;">Name</th>
                    <th style="padding:0.75rem; text-align:left;">Description</th>
                    <th style="padding:0.75rem; text-align:left;">Assigned Users</th>
                    <th style="padding:0.75rem; text-align:left;">Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var project in projects)
                {
                    <tr style="transition:all 0.2s ease; cursor:pointer;"
                        onmouseover="this.style.backgroundColor='#e2cfea'"
                        onmouseout="this.style.backgroundColor='transparent'">
                        <td style="padding:0.75rem;">@project.ProjectId</td>
                        <td style="padding:0.75rem;">@project.Name</td>
                        <td style="padding:0.75rem;">@project.Description</td>
                        <td style="padding:0.75rem;">
                            @if (project.UserProjects != null)
                            {
                                @string.Join(", ", project.UserProjects.Select(up => up.User?.FirstName + " " + up.User?.LastName))
                            }
                        </td>
                        <td style="padding:0.75rem; display:flex; gap:0.5rem;">
                            <button @onclick="() => EditProject(project.Id)"
                                    style="background:#e2cfea; border:none; padding:0.4rem 0.75rem;
                                                   border-radius:0.4rem; font-size:0.9rem; font-weight:600;
                                                   box-shadow:0 2px 6px rgba(0,0,0,0.2);
                                                   transition:all 0.3s ease; cursor:pointer;"
                                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 12px rgba(0,0,0,0.25)'"
                                    onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)'">
                                ✏️ Edit
                            </button>
                            <button @onclick="() => DeleteProject(project.Id)"
                                    style="background:#6247aa; color:white; border:none; padding:0.4rem 0.75rem;
                                                   border-radius:0.4rem; font-size:0.9rem; font-weight:600;
                                                   box-shadow:0 2px 6px rgba(0,0,0,0.25);
                                                   transition:all 0.3s ease; cursor:pointer;"
                                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 12px rgba(0,0,0,0.3)'"
                                    onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 6px rgba(0,0,0,0.25)'">
                                🗑️ Delete
                            </button>
                            <button @onclick="() => AssignUsers(project.Id)"
                                    style="background:#102b3f; color:white; border:none; padding:0.4rem 0.75rem;
                                                   border-radius:0.4rem; font-size:0.9rem; font-weight:600;
                                                   box-shadow:0 2px 6px rgba(0,0,0,0.25);
                                                   transition:all 0.3s ease; cursor:pointer;"
                                    onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 12px rgba(0,0,0,0.3)'"
                                    onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 6px rgba(0,0,0,0.25)'">
                                👥 Assign
                            </button>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    }

</ProtectedPage>

@code {
    private List<Project>? projects;
    private string[] managerRoles = new[] { "Manager" };

    protected override async Task OnInitializedAsync()
    {
        projects = await ProjectService.GetProjectsAsync();
    }

    private void ShowAddProject()
    {
        Navigation.NavigateTo("/manager/projects/form");
    }

    private void EditProject(int id)
    {
        Navigation.NavigateTo($"/manager/projects/form/{id}");
    }

    private async Task DeleteProject(int id)
    {
        await ProjectService.DeleteProjectAsync(id);
        projects = await ProjectService.GetProjectsAsync();
    }

    private void AssignUsers(int id)
    {
        Navigation.NavigateTo($"/manager/projects/assign/{id}");
    }
}
