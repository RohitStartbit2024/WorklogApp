@page "/manager/projects/form/{Id:int?}"
@using WorklogApp.Models
@using WorklogApp.Services
@inject ProjectService ProjectService
@inject CurrentUserService CurrentUserService
@inject NavigationManager Navigation

<ProtectedPage TPage="object" AllowedRoles="@managerRoles">

    <h3 style="text-align:center; color:#6247aa; padding:0.75rem 1rem;">
        @(Id == 0 ? "Add Project" : "Edit Project")
    </h3>

    @if (!CurrentUserLoaded)
    {
        <p><em>Loading...</em></p>
    }
    else if (CurrentUserService.CurrentUser == null)
    {
        <p style="color:#6247aa; font-weight:600;">⚠️ You must be logged in as a manager to create/edit projects.</p>
    }
    else
    {
        <EditForm Model="@project" OnValidSubmit="SaveProject"
                  style="background:#ffffff; padding:1.5rem; border-radius:0.75rem;
                             box-shadow:0 4px 12px rgba(0,0,0,0.15); max-width:600px;">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div style="margin-bottom:1rem;">
                <label style="font-weight:600; color:#102b3f;">Project ID</label>
                <InputText @bind-Value="project.ProjectId" placeholder="Enter project ID"
                           style="width:100%; padding:0.5rem 0.75rem; font-size:1rem;
                                      border-radius:0.375rem; border:1px solid #ccc;
                                      background:#f7f0fc; margin-top:0.25rem;
                                      transition:all 0.3s ease;"
                           onfocus="this.style.boxShadow='0 0 0 3px #e2cfea'"
                           onblur="this.style.boxShadow='none'" />
            </div>

            <div style="margin-bottom:1rem;">
                <label style="font-weight:600; color:#102b3f;">Name</label>
                <InputText @bind-Value="project.Name" placeholder="Enter project name"
                           style="width:100%; padding:0.5rem 0.75rem; font-size:1rem;
                                      border-radius:0.375rem; border:1px solid #ccc;
                                      background:#f7f0fc; margin-top:0.25rem;
                                      transition:all 0.3s ease;"
                           onfocus="this.style.boxShadow='0 0 0 3px #e2cfea'"
                           onblur="this.style.boxShadow='none'" />
            </div>

            <div style="margin-bottom:1.25rem;">
                <label style="font-weight:600; color:#102b3f;">Description</label>
                <InputTextArea @bind-Value="project.Description" placeholder="Enter project description"
                               style="width:100%; padding:0.75rem; font-size:1rem;
                                          border-radius:0.375rem; border:1px solid #ccc;
                                          background:#f7f0fc; margin-top:0.25rem; min-height:100px;
                                          transition:all 0.3s ease; resize:vertical;"
                               onfocus="this.style.boxShadow='0 0 0 3px #e2cfea'"
                               onblur="this.style.boxShadow='none'" />
            </div>

            <div style="display:flex; gap:1rem;">
                <button type="submit"
                        style="background:linear-gradient(90deg,#a06cd5,#6247aa);
                                   border:none; padding:0.6rem 1.25rem;
                                   border-radius:0.5rem; color:white; font-weight:600;
                                   box-shadow:0 3px 8px rgba(0,0,0,0.25);
                                   transition:all 0.3s ease; cursor:pointer;"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 6px 18px rgba(98,71,170,0.5)'"
                        onmouseout="this.style.transform='none';this.style.boxShadow='0 3px 8px rgba(0,0,0,0.25)'">
                    💾 Save
                </button>

                <button type="button" @onclick="Cancel"
                        style="background:#e2cfea; border:none; padding:0.6rem 1.25rem;
                                   border-radius:0.5rem; font-weight:600;
                                   box-shadow:0 2px 6px rgba(0,0,0,0.2);
                                   transition:all 0.3s ease; cursor:pointer;"
                        onmouseover="this.style.transform='translateY(-2px)';this.style.boxShadow='0 5px 12px rgba(0,0,0,0.25)'"
                        onmouseout="this.style.transform='none';this.style.boxShadow='0 2px 6px rgba(0,0,0,0.2)'">
                    ❌ Cancel
                </button>
            </div>
        </EditForm>
    }

</ProtectedPage>

@code {
    [Parameter] public int? Id { get; set; }
    private Project project = new();
    private bool CurrentUserLoaded = false;

    private string[] managerRoles = new[] { "Manager" };

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await CurrentUserService.LoadUserAsync();
            CurrentUserLoaded = true;
            StateHasChanged();

            if (Id.HasValue && Id.Value > 0)
            {
                var existing = await ProjectService.GetProjectAsync(Id.Value);
                if (existing != null)
                {
                    project = existing;
                }
            }
        }
    }

    private async Task SaveProject()
    {
        if (Id == null || Id == 0)
            await ProjectService.AddProjectAsync(project);
        else
            await ProjectService.UpdateProjectAsync(project);

        Navigation.NavigateTo("/manager/projects");
    }

    private void Cancel()
    {
        Navigation.NavigateTo("/manager/projects");
    }
}
